name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate manifest.json
        run: |
          echo "Validating manifest.json..."
          node -e "
            const m = require('./manifest.json');
            const required = ['manifest_version', 'name', 'version', 'content_scripts', 'icons'];
            for (const key of required) {
              if (!m[key]) { console.error('Missing: ' + key); process.exit(1); }
            }
            console.log('✅ manifest.json is valid');
            console.log('   Name:', m.name);
            console.log('   Version:', m.version);
          "

      - name: Verify icons exist
        run: |
          for size in 16 32 48 128; do
            if [ ! -f "icons/icon${size}.png" ]; then
              echo "❌ Missing icons/icon${size}.png"
              exit 1
            fi
          done
          echo "✅ All icons present"

  release:
    needs: validate
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Extension ZIP
        run: |
          zip -r github-pr-visual-editor.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "*.md" \
            -x ".*" \
            -x "node_modules/*" \
            -x "package.json" \
            -x "package-lock.json" \
            -x "create-icons.js" \
            -x "generate-icons.html" \
            -x "npm-debug.log"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: GitHub PR Visual Editor ${{ steps.version.outputs.tag }}
          body: |
            ## GitHub PR Visual Editor ${{ steps.version.outputs.tag }}

            ### Installation
            1. Download `github-pr-visual-editor.zip` below
            2. Unzip to a folder
            3. Open `chrome://extensions/` → Enable Developer Mode → Load Unpacked → Select the folder
          files: github-pr-visual-editor.zip
